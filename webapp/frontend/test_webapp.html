<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тестовый WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        button { font-size: 18px; padding: 10px 20px; cursor: pointer; }
        #debug { margin-top: 20px; padding: 10px; background-color: #f0f0f0; border: 1px solid #ccc; text-align: left; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Тестовый WebApp</h1>
    <button id="sendTestDataBtn">Отправить тестовые данные</button>
    <div id="debug">Логи фронтенда:<br></div>

    <script>
        const tg = window.Telegram.WebApp;
        const debugLog = document.getElementById('debug');

        function logToDebug(message) {
            console.log(message);
            debugLog.innerHTML += message + '\n';
        }

        if (tg) {
            tg.expand();
            logToDebug('Telegram WebApp SDK загружен и готов.');
            logToDebug('initData: ' + (tg.initData ? 'присутствует' : 'ОТСУТСТВУЕТ'));
            logToDebug('initDataUnsafe: ' + JSON.stringify(tg.initDataUnsafe, null, 2));

            if (!tg.initData) {
                logToDebug('[CRITICAL] initData отсутствует! tg.sendData может не работать корректно. Откройте WebApp из Telegram.');
                // alert('Критическая ошибка: initData отсутствует. Пожалуйста, откройте это веб-приложение через кнопку в Telegram.');
            }
             if (!tg.initDataUnsafe || !tg.initDataUnsafe.query_id) {
                logToDebug('[CRITICAL] query_id отсутствует в initDataUnsafe! tg.sendData будет вызван без него, что может привести к невозможности вызвать answerWebAppQuery на бэкенде.');
            }


            tg.MainButton.setText("Отправить из MainButton");
            tg.MainButton.show();
            tg.MainButton.onClick(function() {
                sendData("main_button_click");
            });
            
            document.getElementById('sendTestDataBtn').addEventListener('click', function() {
                sendData("html_button_click");
            });

        } else {
            logToDebug('Telegram WebApp SDK не найден. Убедитесь, что открываете в клиенте Telegram.');
        }

        function sendData(source) {
            logToDebug('=== НАЧАЛО ОТПРАВКИ ДАННЫХ ===');
            logToDebug('Функция sendData вызвана от: ' + source);
            logToDebug('Проверка состояния Telegram WebApp...');
            
            // Детальная проверка состояния tg объекта
            if (!tg) {
                logToDebug('[CRITICAL ERROR] Telegram WebApp объект не инициализирован (tg = null/undefined)');
                alert('Критическая ошибка: Telegram WebApp не инициализирован.');
                return;
            }
            
            if (typeof tg.sendData !== 'function') {
                logToDebug('[CRITICAL ERROR] tg.sendData не является функцией. Тип: ' + typeof tg.sendData);
                alert('Критическая ошибка: tg.sendData недоступен.');
                return;
            }
            
            logToDebug('[OK] tg объект и tg.sendData доступны');
            
            // Проверка критически важных данных
            logToDebug('Проверка критически важных данных...');
            logToDebug('tg.initData: ' + (tg.initData ? 'ПРИСУТСТВУЕТ (длина: ' + tg.initData.length + ')' : 'ОТСУТСТВУЕТ'));
            logToDebug('tg.initDataUnsafe: ' + JSON.stringify(tg.initDataUnsafe, null, 2));
            
            const queryId = tg.initDataUnsafe ? tg.initDataUnsafe.query_id : null;
            const userId = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
            
            logToDebug('Извлеченные данные:');
            logToDebug('- query_id: ' + (queryId || 'ОТСУТСТВУЕТ'));
            logToDebug('- user_id: ' + (userId || 'ОТСУТСТВУЕТ'));
            
            if (!queryId) {
                logToDebug('[WARNING] query_id отсутствует! Бот не сможет вызвать answerWebAppQuery');
            }
            
            if (!userId) {
                logToDebug('[WARNING] user_id отсутствует! Это может быть проблемой для идентификации');
            }

            // Формирование данных для отправки
            const dataToSend = {
                test_type: 'test_webapp_send',
                event_source: source,
                timestamp: new Date().toISOString(),
                message: "Тестовое сообщение от test_webapp.html",
                query_id: queryId,
                user_id: userId,
                webapp_info: {
                    initData_available: !!tg.initData,
                    initData_length: tg.initData ? tg.initData.length : 0,
                    initDataUnsafe_available: !!tg.initDataUnsafe,
                    browser_info: navigator.userAgent
                }
            };
            
            const jsonString = JSON.stringify(dataToSend, null, 2);
            logToDebug('Подготовлены данные для отправки:');
            logToDebug(jsonString);
            
            // Попытка отправки
            logToDebug('=== ПОПЫТКА ОТПРАВКИ ===');
            try {
                logToDebug('Вызов tg.sendData()...');
                tg.sendData(JSON.stringify(dataToSend));
                logToDebug('[SUCCESS] tg.sendData() УСПЕШНО ВЫЗВАНА!');
                logToDebug('Отправленные данные: ' + JSON.stringify(dataToSend));
                
                alert('✅ УСПЕХ: tg.sendData() была вызвана!\n\nТеперь проверьте:\n1. Логи бота в терминале\n2. Получает ли бот web_app_data\n\nОтправленные данные:\n' + JSON.stringify(dataToSend, null, 2));
            } catch (error) {
                logToDebug('[CRITICAL ERROR] Исключение при вызове tg.sendData():');
                logToDebug('Тип ошибки: ' + error.name);
                logToDebug('Сообщение ошибки: ' + error.message);
                logToDebug('Стек ошибки: ' + error.stack);
                
                alert('❌ ОШИБКА при отправке:\n' + error.name + ': ' + error.message + '\n\nПодробности в консоли и логах на странице.');
            }
            
            logToDebug('=== КОНЕЦ ОТПРАВКИ ДАННЫХ ===');
        }
    </script>
</body>
</html> 