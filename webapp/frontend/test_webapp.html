<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç–æ–≤—ã–π WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        button { font-size: 18px; padding: 10px 20px; cursor: pointer; }
        #debug { margin-top: 20px; padding: 10px; background-color: #f0f0f0; border: 1px solid #ccc; text-align: left; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç–æ–≤—ã–π WebApp</h1>
    <button id="sendTestDataBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
    <div id="debug">–õ–æ–≥–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:<br></div>

    <script>
        const tg = window.Telegram.WebApp;
        const debugLog = document.getElementById('debug');

        function logToDebug(message) {
            console.log(message);
            debugLog.innerHTML += message + '\n';
        }

        if (tg) {
            tg.expand();
            logToDebug('Telegram WebApp SDK –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤.');
            logToDebug('initData: ' + (tg.initData ? '–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç' : '–û–¢–°–£–¢–°–¢–í–£–ï–¢'));
            logToDebug('initDataUnsafe: ' + JSON.stringify(tg.initDataUnsafe, null, 2));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            tg.onEvent('messageSent', function() {
                logToDebug('üéâ [EVENT] messageSent - –ë–æ—Ç –ø–æ–ª—É—á–∏–ª –∏ –æ–±—Ä–∞–±–æ—Ç–∞–ª –¥–∞–Ω–Ω—ã–µ!');
                alert('üéâ –£–°–ü–ï–•! –ë–æ—Ç –ø–æ–ª—É—á–∏–ª –¥–∞–Ω–Ω—ã–µ (—Å–æ–±—ã—Ç–∏–µ messageSent)');
            });
            
            tg.onEvent('messageError', function(error) {
                logToDebug('‚ùå [EVENT] messageError - –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + JSON.stringify(error));
                alert('‚ùå –û–®–ò–ë–ö–ê! –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É: ' + JSON.stringify(error));
            });

            if (!tg.initData) {
                logToDebug('[CRITICAL] initData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç! tg.sendData –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –û—Ç–∫—Ä–æ–π—Ç–µ WebApp –∏–∑ Telegram.');
                // alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: initData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram.');
            }
             if (!tg.initDataUnsafe || !tg.initDataUnsafe.query_id) {
                logToDebug('[CRITICAL] query_id –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ initDataUnsafe! tg.sendData –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –±–µ–∑ –Ω–µ–≥–æ, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–∑–≤–∞—Ç—å answerWebAppQuery –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.');
            }


            tg.MainButton.setText("–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑ MainButton");
            tg.MainButton.show();
            tg.MainButton.onClick(function() {
                sendData("main_button_click");
            });
            
            document.getElementById('sendTestDataBtn').addEventListener('click', function() {
                sendData("html_button_click");
            });

        } else {
            logToDebug('Telegram WebApp SDK –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ –≤ –∫–ª–∏–µ–Ω—Ç–µ Telegram.');
        }

        function sendData(source) {
            logToDebug('=== –ù–ê–ß–ê–õ–û –û–¢–ü–†–ê–í–ö–ò –î–ê–ù–ù–´–• ===');
            logToDebug('–§—É–Ω–∫—Ü–∏—è sendData –≤—ã–∑–≤–∞–Ω–∞ –æ—Ç: ' + source);
            logToDebug('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Telegram WebApp...');
            
            // –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è tg –æ–±—ä–µ–∫—Ç–∞
            if (!tg) {
                logToDebug('[CRITICAL ERROR] Telegram WebApp –æ–±—ä–µ–∫—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (tg = null/undefined)');
                alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: Telegram WebApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.');
                return;
            }
            
            if (typeof tg.sendData !== 'function') {
                logToDebug('[CRITICAL ERROR] tg.sendData –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π. –¢–∏–ø: ' + typeof tg.sendData);
                alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: tg.sendData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
                return;
            }
            
            logToDebug('[OK] tg –æ–±—ä–µ–∫—Ç –∏ tg.sendData –¥–æ—Å—Ç—É–ø–Ω—ã');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            logToDebug('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
            logToDebug('tg.initData: ' + (tg.initData ? '–ü–†–ò–°–£–¢–°–¢–í–£–ï–¢ (–¥–ª–∏–Ω–∞: ' + tg.initData.length + ')' : '–û–¢–°–£–¢–°–¢–í–£–ï–¢'));
            logToDebug('tg.initDataUnsafe: ' + JSON.stringify(tg.initDataUnsafe, null, 2));
            
            const queryId = tg.initDataUnsafe ? tg.initDataUnsafe.query_id : null;
            const userId = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
            
            logToDebug('–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:');
            logToDebug('- query_id: ' + (queryId || '–û–¢–°–£–¢–°–¢–í–£–ï–¢'));
            logToDebug('- user_id: ' + (userId || '–û–¢–°–£–¢–°–¢–í–£–ï–¢'));
            
            if (!queryId) {
                logToDebug('[WARNING] query_id –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç! –ë–æ—Ç –Ω–µ —Å–º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å answerWebAppQuery');
            }
            
            if (!userId) {
                logToDebug('[WARNING] user_id –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç! –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
            }

            // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const dataToSend = {
                test_type: 'test_webapp_send',
                event_source: source,
                timestamp: new Date().toISOString(),
                message: "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç test_webapp.html",
                query_id: queryId,
                user_id: userId,
                webapp_info: {
                    initData_available: !!tg.initData,
                    initData_length: tg.initData ? tg.initData.length : 0,
                    initDataUnsafe_available: !!tg.initDataUnsafe,
                    browser_info: navigator.userAgent
                }
            };
            
            const jsonString = JSON.stringify(dataToSend, null, 2);
            logToDebug('–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:');
            logToDebug(jsonString);
            
            // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
            logToDebug('=== –ü–û–ü–´–¢–ö–ê –û–¢–ü–†–ê–í–ö–ò ===');
            try {
                logToDebug('–í—ã–∑–æ–≤ tg.sendData()...');
                tg.sendData(JSON.stringify(dataToSend));
                logToDebug('[SUCCESS] tg.sendData() –£–°–ü–ï–®–ù–û –í–´–ó–í–ê–ù–ê!');
                logToDebug('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ' + JSON.stringify(dataToSend));
                logToDebug('[INFO] ‚è±Ô∏è –û–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 20 —Å–µ–∫—É–Ω–¥...');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                setTimeout(() => {
                    logToDebug('[TIMEOUT] ‚è∞ –ü—Ä–æ—à–ª–æ 20 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                    logToDebug('[ACTION] –ï—Å–ª–∏ –±–æ—Ç –ù–ï –ø–æ–ª—É—á–∏–ª web_app_data, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:');
                    logToDebug('1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–º–µ–Ω–∞ –≤ BotFather (/setdomain)');
                    logToDebug('2. HTTPS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–æ–º–µ–Ω–∞');
                    logToDebug('3. –í–µ—Ä—Å–∏—é Telegram –∫–ª–∏–µ–Ω—Ç–∞');
                    alert('‚è∞ –ü–†–û–®–õ–û 20 –°–ï–ö–£–ù–î\n\n–ï—Å–ª–∏ –≤ –ª–æ–≥–∞—Ö –±–æ—Ç–∞ –ù–ï–¢ web_app_data —Å–æ–æ–±—â–µ–Ω–∏–π, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:\n\n1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–º–µ–Ω–∞ –≤ BotFather\n2. HTTPS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç\n3. –í–µ—Ä—Å–∏—é Telegram –∫–ª–∏–µ–Ω—Ç–∞');
                }, 20000);
                
                alert('‚úÖ –£–°–ü–ï–•: tg.sendData() –±—ã–ª–∞ –≤—ã–∑–≤–∞–Ω–∞!\n\n–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –õ–æ–≥–∏ –±–æ—Ç–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ\n2. –ü–æ–ª—É—á–∞–µ—Ç –ª–∏ –±–æ—Ç web_app_data\n\n–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\n' + JSON.stringify(dataToSend, null, 2));
            } catch (error) {
                logToDebug('[CRITICAL ERROR] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ tg.sendData():');
                logToDebug('–¢–∏–ø –æ—à–∏–±–∫–∏: ' + error.name);
                logToDebug('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—à–∏–±–∫–∏: ' + error.message);
                logToDebug('–°—Ç–µ–∫ –æ—à–∏–±–∫–∏: ' + error.stack);
                
                alert('‚ùå –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:\n' + error.name + ': ' + error.message + '\n\n–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –∏ –ª–æ–≥–∞—Ö –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.');
            }
            
            logToDebug('=== –ö–û–ù–ï–¶ –û–¢–ü–†–ê–í–ö–ò –î–ê–ù–ù–´–• ===');
        }
    </script>
</body>
</html> 