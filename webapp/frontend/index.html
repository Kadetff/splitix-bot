<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞–∑–¥–µ–ª–∏ —á–µ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f1f1f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            line-height: 1.4;
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--tg-theme-hint-color);
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
        }

        .receipt-info {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .receipt-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .total-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .total-info.main {
            font-weight: 600;
            font-size: 16px;
            padding-top: 8px;
            border-top: 1px solid var(--tg-theme-hint-color);
        }

        .items-list {
            margin-bottom: 24px;
        }

        .item {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .item:hover {
            transform: translateY(-1px);
        }

        .item.selected {
            border-color: var(--tg-theme-button-color);
            background: rgba(36, 129, 204, 0.1);
        }

        .item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .item-name {
            font-weight: 600;
            font-size: 16px;
            flex: 1;
            margin-right: 12px;
        }

        .item-price {
            font-weight: 600;
            font-size: 16px;
            color: var(--tg-theme-button-color);
        }

        .item-details {
            color: var(--tg-theme-hint-color);
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-quantity {
            font-size: 14px;
        }

        .item-total {
            font-weight: 500;
        }

        .selection-summary {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            position: sticky;
            bottom: 80px;
            z-index: 10;
        }

        .selection-summary h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .summary-row.total {
            font-weight: 600;
            font-size: 16px;
            padding-top: 8px;
            border-top: 1px solid var(--tg-theme-hint-color);
        }

        .confirm-button {
            position: fixed;
            bottom: 16px;
            left: 16px;
            right: 16px;
            max-width: 480px;
            margin: 0 auto;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .confirm-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .confirm-button:not(:disabled):hover {
            opacity: 0.9;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--tg-theme-hint-color);
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .item.selected .checkbox {
            background: var(--tg-theme-button-color);
            border-color: var(--tg-theme-button-color);
        }

        .item.selected .checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .item-content {
            display: flex;
            align-items: flex-start;
        }

        .item-info {
            flex: 1;
        }

        @media (max-width: 480px) {
            body {
                padding: 12px;
            }
            
            .confirm-button {
                left: 12px;
                right: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã –†–∞–∑–¥–µ–ª–∏ —á–µ–∫</h1>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–∏ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —á–µ–∫–∞</p>
        </div>

        <div id="loading" class="loading">
            <p>‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ —á–µ–∫–∞...</p>
        </div>

        <div id="error" class="error" style="display: none;">
            <p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ–∫–∞</p>
        </div>

        <div id="content" style="display: none;">
            <div id="receiptInfo" class="receipt-info">
                <h3>üí∞ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–µ–∫–µ</h3>
                <div id="receiptTotals"></div>
            </div>

            <div id="itemsList" class="items-list"></div>

            <div id="selectionSummary" class="selection-summary">
                <h3>üìä –í–∞—à –≤—ã–±–æ—Ä</h3>
                <div id="summaryContent">
                    <div class="summary-row">
                        <span>–ü–æ–∑–∏—Ü–∏–π –≤—ã–±—Ä–∞–Ω–æ:</span>
                        <span id="selectedCount">0</span>
                    </div>
                    <div class="summary-row">
                        <span>–°—É–º–º–∞ –ø–æ–∑–∏—Ü–∏–π:</span>
                        <span id="selectedSum">0 ‚ÇΩ</span>
                    </div>
                    <div class="summary-row" id="discountRow" style="display: none;">
                        <span>–°–∫–∏–¥–∫–∞:</span>
                        <span id="discountAmount">0 ‚ÇΩ</span>
                    </div>
                    <div class="summary-row" id="serviceRow" style="display: none;">
                        <span>–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–±–æ—Ä:</span>
                        <span id="serviceAmount">0 ‚ÇΩ</span>
                    </div>
                    <div class="summary-row total">
                        <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                        <span id="totalAmount">0 ‚ÇΩ</span>
                    </div>
                </div>
            </div>
        </div>

        <button id="confirmButton" class="confirm-button" disabled>
            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let receiptData = null;
        let selectedItems = new Set();
        let isInlineButton = false;
        let queryId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (tg) {
            tg.ready();
            tg.expand();
            tg.enableClosingConfirmation = false;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–Ω–æ–ø–∫–∏
            if (tg.initDataUnsafe && tg.initDataUnsafe.query_id) {
                queryId = tg.initDataUnsafe.query_id;
                isInlineButton = true;
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ message_id –∏–∑ URL
        function getMessageId() {
            const path = window.location.pathname;
            const match = path.match(/\/app\/(\d+)$/);
            return match ? match[1] : null;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ–∫–∞
        async function loadReceiptData() {
            const messageId = getMessageId();
            if (!messageId) {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }

            try {
                const response = await fetch(`/api/receipt/${messageId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                receiptData = await response.json();
                renderReceipt();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ–∫–∞');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').querySelector('p').textContent = `‚ùå ${message}`;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ–∫–∞
        function renderReceipt() {
            if (!receiptData || !receiptData.items) {
                showError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ–∫–∞');
                return;
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            renderReceiptInfo();
            renderItems();
            updateSummary();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–µ–∫–µ
        function renderReceiptInfo() {
            const totalsDiv = document.getElementById('receiptTotals');
            let html = '';

            const itemsTotal = receiptData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            html += `<div class="total-info"><span>–°—É–º–º–∞ –ø–æ–∑–∏—Ü–∏–π:</span><span>${itemsTotal.toFixed(2)} ‚ÇΩ</span></div>`;

            if (receiptData.total_discount_amount) {
                html += `<div class="total-info"><span>–°–∫–∏–¥–∫–∞:</span><span>-${receiptData.total_discount_amount.toFixed(2)} ‚ÇΩ</span></div>`;
            }

            if (receiptData.service_charge_percent) {
                const serviceAmount = itemsTotal * (receiptData.service_charge_percent / 100);
                html += `<div class="total-info"><span>–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–±–æ—Ä (${receiptData.service_charge_percent}%):</span><span>+${serviceAmount.toFixed(2)} ‚ÇΩ</span></div>`;
            }

            if (receiptData.total_check_amount) {
                html += `<div class="total-info main"><span>–ò—Ç–æ–≥–æ –ø–æ —á–µ–∫—É:</span><span>${receiptData.total_check_amount.toFixed(2)} ‚ÇΩ</span></div>`;
            }

            totalsDiv.innerHTML = html;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
        function renderItems() {
            const itemsList = document.getElementById('itemsList');
            let html = '';

            receiptData.items.forEach((item, index) => {
                const total = item.price * item.quantity;
                html += `
                    <div class="item" data-index="${index}" onclick="toggleItem(${index})">
                        <div class="item-content">
                            <div class="checkbox"></div>
                            <div class="item-info">
                                <div class="item-header">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-price">${item.price.toFixed(2)} ‚ÇΩ</div>
                                </div>
                                <div class="item-details">
                                    <div class="item-quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity}</div>
                                    <div class="item-total">–ò—Ç–æ–≥–æ: ${total.toFixed(2)} ‚ÇΩ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            itemsList.innerHTML = html;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏
        function toggleItem(index) {
            const item = document.querySelector(`[data-index="${index}"]`);
            
            if (selectedItems.has(index)) {
                selectedItems.delete(index);
                item.classList.remove('selected');
            } else {
                selectedItems.add(index);
                item.classList.add('selected');
            }

            updateSummary();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏
        function updateSummary() {
            const selectedCount = selectedItems.size;
            const selectedSum = Array.from(selectedItems).reduce((sum, index) => {
                const item = receiptData.items[index];
                return sum + (item.price * item.quantity);
            }, 0);

            document.getElementById('selectedCount').textContent = selectedCount;
            document.getElementById('selectedSum').textContent = `${selectedSum.toFixed(2)} ‚ÇΩ`;

            // –†–∞—Å—á–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å–∫–∏–¥–∫–∏ –∏ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Å–±–æ—Ä–∞
            const totalItemsSum = receiptData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const proportion = totalItemsSum > 0 ? selectedSum / totalItemsSum : 0;

            let discountAmount = 0;
            let serviceAmount = 0;
            let finalTotal = selectedSum;

            if (receiptData.total_discount_amount && selectedSum > 0) {
                discountAmount = receiptData.total_discount_amount * proportion;
                finalTotal -= discountAmount;
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('discountAmount').textContent = `-${discountAmount.toFixed(2)} ‚ÇΩ`;
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }

            if (receiptData.service_charge_percent && selectedSum > 0) {
                serviceAmount = selectedSum * (receiptData.service_charge_percent / 100);
                finalTotal += serviceAmount;
                document.getElementById('serviceRow').style.display = 'flex';
                document.getElementById('serviceAmount').textContent = `+${serviceAmount.toFixed(2)} ‚ÇΩ`;
            } else {
                document.getElementById('serviceRow').style.display = 'none';
            }

            document.getElementById('totalAmount').textContent = `${finalTotal.toFixed(2)} ‚ÇΩ`;

            // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = selectedCount === 0;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram
        async function sendDataToTelegram(data) {
            try {
                if (isInlineButton && queryId) {
                    // –î–ª—è Inline-–∫–Ω–æ–ø–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º answerWebAppQuery
                    const response = await fetch('/api/answer_webapp_query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            query_id: queryId,
                            data: data,
                            title: "–í—ã–±–æ—Ä –ø–æ–∑–∏—Ü–∏–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω",
                            description: `–í—ã–±—Ä–∞–Ω–æ –ø–æ–∑–∏—Ü–∏–π: ${data.selected_items.length}`
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    return true;
                } else {
                    // –î–ª—è Reply-–∫–Ω–æ–ø–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º sendData
                    if (tg && typeof tg.sendData === 'function') {
                        tg.sendData(JSON.stringify(data));
                        return true;
                    } else {
                        throw new Error('tg.sendData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                alert(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
                return false;
            }
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
        async function confirmSelection() {
            if (selectedItems.size === 0) return;

            const selectedItemsData = Array.from(selectedItems).map(index => ({
                index: index,
                ...receiptData.items[index]
            }));

            const totalItemsSum = receiptData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const selectedSum = selectedItemsData.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const proportion = totalItemsSum > 0 ? selectedSum / totalItemsSum : 0;

            const discountAmount = receiptData.total_discount_amount ? receiptData.total_discount_amount * proportion : 0;
            const serviceAmount = receiptData.service_charge_percent ? selectedSum * (receiptData.service_charge_percent / 100) : 0;
            const finalTotal = selectedSum - discountAmount + serviceAmount;

            const data = {
                message_id: getMessageId(),
                selected_items: selectedItemsData,
                summary: {
                    items_total: selectedSum,
                    discount_amount: discountAmount,
                    service_amount: serviceAmount,
                    final_total: finalTotal,
                    items_count: selectedItems.size
                },
                timestamp: Date.now()
            };

            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = true;
            confirmButton.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è—é...';

            const success = await sendDataToTelegram(data);
            
            if (success) {
                confirmButton.textContent = '‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    if (tg && tg.close) {
                        tg.close();
                    }
                }, 1000);
            } else {
                confirmButton.disabled = false;
                confirmButton.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        document.getElementById('confirmButton').addEventListener('click', confirmSelection);

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', loadReceiptData);
    </script>
</body>
</html> 