# Технический контекст Split Check Bot

## Стек технологий
- **Бот**: Python 3.12, aiogram 3.0+, asyncio, aiohttp
- **AI**: OpenAI API (GPT-4 Vision), модель gpt-4.1-mini
- **Веб**: Flask 2.x, Telegram WebApp SDK, Vanilla JS
- **Деплой**: Heroku Container Runtime
- **Данные**: JSON-файлы (MVP), планируется PostgreSQL/Redis/S3

## Архитектура
1. **Telegram Bot (main.py)** – обработка сообщений и команд
2. **WebApp Server (Flask)** – API для работы с чеками
3. **WebApp Client (JS)** – интерфейс выбора позиций
4. **Сервисы** – OCR чеков, бизнес-логика распределений

## Потоки данных
- **Распознавание**: Фото → Бот → OpenAI → Структурированные данные
- **Выбор товаров**: Бот → WebApp → Выбор позиций → Возврат в бот
- **Расчет**: Выборы пользователей → Расчет с учетом скидок → Результат
- **Взаиморасчеты**: Выборы → Ввод платежей → Simplify Debts → Кто-кому-сколько

## Ключевые особенности
- **Формат данных**: JSON-структуры для чеков и выборов позиций
- **Алгоритмы**: Пропорциональное распределение скидок, Simplify Debts
- **Валюта**: Decimal для точных денежных расчетов
- **TTL данных**: 7 дней хранения, автоочистка

## API-эндпоинты
- `GET/POST /api/receipt/{message_id}` – получение/сохранение чека
- `POST /api/selection/{message_id}` – сохранение выбора пользователя

## Режимы работы
- **Индивидуальный**: фото чека → личный выбор позиций
- **Групповой**: `/split` → параллельный выбор → взаиморасчеты

## Конфигурация
- **Env переменные**: TELEGRAM_BOT_TOKEN, OPENAI_API_KEY, WEBAPP_URL, PORT, MODEL_PROVIDER

## Планируемые улучшения
- **Хранение**: PostgreSQL, Redis (сессии), S3 (медиа)
- **Frontend**: React + TypeScript
- **Задачи**: Celery/RQ для асинхронных операций
- **DevOps**: Docker, GitHub Actions, структурированное логирование 